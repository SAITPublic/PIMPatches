From 483d701e768c34e5708f63f6aa20fd7f3bb2cfe6 Mon Sep 17 00:00:00 2001
From: Lukas Sommer <lukas.sommer@codeplay.com>
Date: Mon, 15 Aug 2022 13:03:10 +0000
Subject: [PATCH] Accept code triple generated by DPC++ for SYCL

---
 rocclr/hip_code_object.cpp | 3 +++
 rocclr/hip_code_object.hpp | 1 +
 2 files changed, 4 insertions(+)

diff --git a/rocclr/hip_code_object.cpp b/rocclr/hip_code_object.cpp
index 61f803ae..2bf34499 100755
--- a/rocclr/hip_code_object.cpp
+++ b/rocclr/hip_code_object.cpp
@@ -95,6 +95,9 @@ hipError_t CodeObject::extractCodeObjectFromFatBinary(const void* data,
     } else if (!std::strncmp(desc->triple, HCC_AMDGCN_AMDHSA_TRIPLE,
                sizeof(HCC_AMDGCN_AMDHSA_TRIPLE) - 1)) {
       offset = sizeof(HCC_AMDGCN_AMDHSA_TRIPLE); //For code objects created by Hcc
+    } else if (!std::strncmp(desc->triple, SYCL_AMDGCN_AMDHSA_TRIPLE,
+                             sizeof(SYCL_AMDGCN_AMDHSA_TRIPLE) - 1)) {
+      offset = sizeof(SYCL_AMDGCN_AMDHSA_TRIPLE); //For code objects created by DPC++
     } else {
       continue;
     }
diff --git a/rocclr/hip_code_object.hpp b/rocclr/hip_code_object.hpp
index b5bc234c..a5999855 100755
--- a/rocclr/hip_code_object.hpp
+++ b/rocclr/hip_code_object.hpp
@@ -25,6 +25,7 @@ public:
   #define CLANG_OFFLOAD_BUNDLER_MAGIC_STR "__CLANG_OFFLOAD_BUNDLE__"
   #define HIP_AMDGCN_AMDHSA_TRIPLE "hip-amdgcn-amd-amdhsa"
   #define HCC_AMDGCN_AMDHSA_TRIPLE "hcc-amdgcn-amd-amdhsa-"
+  #define SYCL_AMDGCN_AMDHSA_TRIPLE "hipv4-amdgcn-amd-amdhsa-"
 
   //Clang Offload bundler description & Header
   struct __ClangOffloadBundleDesc {
-- 
2.17.1

